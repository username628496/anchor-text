<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Anchor Text Creator v2</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background-color: #FAF9F6; color: black; font-family: system-ui, sans-serif; }
    .history-entry {
      background-color: white;
      padding: 10px 14px;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      margin-bottom: 10px;
      font-size: 0.95rem;
    }
    .history-entry:hover {
      background-color: #f3f4f6;
    }
    .toggle-details { cursor: pointer; color: #3b82f6; font-size: 0.9rem; }
    .history-box { border-bottom: 1px solid #d1d5db; border-radius: 0.375rem; }
    .history-icon { color: #6b7280; }
    .output-box {
      background-color: white;
      border: 1px solid #e5e7eb;
      border-radius: 0.375rem;
      padding: 12px;
      font-size: 0.95rem;
      line-height: 1.6;
      white-space: pre-wrap;
    }
  </style>
</head>
<body class="bg-[#FAF9F6] text-black font-[system-ui,sans-serif]">
  <header class="bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between">
    <h1 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
      <span class="text-red-600 text-3xl">‚öì</span> Anchor Text Creator
    </h1>
    <span class="text-sm text-gray-500">v2.0</span>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <div class="grid grid-cols-2 gap-4 mb-4">
      <div>
        <label class="font-semibold block mb-1">Nh·∫≠p Anchors</label>
        <textarea id="anchorInput" class="w-full border border-gray-300 rounded-lg p-4 font-mono shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none h-64"></textarea>
      </div>
      <div>
        <label class="font-semibold block mb-1">Nh·∫≠p URLs</label>
        <textarea id="urlInput" class="w-full border border-gray-300 rounded-lg p-4 font-mono shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none h-64"></textarea>
      </div>
    </div>

    <label class="inline-flex items-center mb-4">
      <input type="checkbox" id="targetBlank" class="mr-2" />
      <span>Th√™m <code>target="_blank"</code></span>
    </label>

    <div class="space-x-2 mb-6">
      <button onclick="generateLinks()" class="px-5 py-2 bg-[#141413] text-white rounded-lg hover:bg-[#292929] transition font-semibold shadow">T·∫°o Anchor Text</button>
    </div>

    <p id="warningMessage" class="text-red-400 font-semibold mb-4"></p>

    <section class="mb-6 bg-white border border-gray-300 rounded-md p-4">
      <h3 class="text-lg font-semibold mb-2">Anchor Text Ki·ªÉu 1</h3>
      <div class="output-box overflow-x-auto whitespace-nowrap" id="anchorWithPipes"></div>
      <button onclick="copyDivContent('anchorWithPipes')" class="mt-2 px-4 py-1 bg-[#141413] text-white rounded hover:bg-[#292929] transition text-sm font-medium">Copy</button>
    </section>

    <section class="mb-6 bg-white border border-gray-300 rounded-md p-4">
      <h3 class="text-lg font-semibold mb-2">Anchor Text Ki·ªÉu 2</h3>
      <div class="output-box overflow-x-auto whitespace-nowrap" id="anchorWithSpaces"></div>
      <button onclick="copyDivContent('anchorWithSpaces')" class="mt-2 px-4 py-1 bg-[#141413] text-white rounded hover:bg-[#292929] transition text-sm font-medium">Copy</button>
    </section>

    <section class="mb-10 bg-white border border-gray-300 rounded-md p-4 history-box text-sm">
      <h3 class="text-lg font-semibold mb-2 flex items-center gap-2"><span class="history-icon">üïò</span> L·ªãch S·ª≠ Thao T√°c</h3>
      <div id="historyLog"></div>
    </section>
  </main>

  <footer class="bg-gray-800 text-white text-center py-4">
    –ü –∏ —Ç–µ—Ä ¬© 2025
  </footer>

<script>
  function normalizeUrl(url) {
    url = url.trim();
    if (!/^https?:\/\//i.test(url)) {
      url = "https://" + url.replace(/^\/*/, "");
    }
    url = url.replace(/^http:(?!\/\/)/i, "http://");
    url = url.replace(/^https:(?!\/\/)/i, "https://");
    return url;
  }

  async function generateLinks() {
    const anchors = document.getElementById("anchorInput").value.trim().split("\n");
    const urls = document.getElementById("urlInput").value.trim().split("\n");
    const targetBlank = document.getElementById("targetBlank").checked;
    const minLength = Math.min(anchors.length, urls.length);

    document.getElementById("warningMessage").innerText = anchors.length !== urls.length 
      ? `‚ö†Ô∏è Anchor: ${anchors.length}, URL: ${urls.length}. X·ª≠ l√Ω ${minLength} d√≤ng.` : "";

    let pipeLinks = "", spaceLinks = "", pairs = [];
    for (let i = 0; i < minLength; i++) {
      const anchor = anchors[i].trim();
      const url = normalizeUrl(urls[i].trim());
      let output = anchor.startsWith("http") ? url : `<a href="${url}"${targetBlank ? ' target="_blank"' : ''}>${anchor}</a>`;
      pipeLinks += output + (i < minLength -1 ? " | " : "");
      spaceLinks += output + " ";
      pairs.push({ anchor, url });
    }

    document.getElementById("anchorWithPipes").innerHTML = pipeLinks.trim();
    document.getElementById("anchorWithSpaces").innerHTML = spaceLinks.trim();

    try {
      await fetch("/api/history", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ pairs })
      });
    } catch (err) { console.error("L·ªói khi l∆∞u l·ªãch s·ª≠:", err); }

    const popup = document.createElement("div");
    popup.innerText = `ƒê√£ t·∫°o ${minLength} anchor text!`;
    popup.className = "fixed bottom-4 right-4 bg-blue-600 text-white px-4 py-2 rounded shadow-lg animate-bounce";
    document.body.appendChild(popup);
    setTimeout(() => popup.remove(), 2000);

    renderHistory();
  }

  async function renderHistory() {
    const container = document.getElementById("historyLog");
    container.innerHTML = "";
    try {
      const res = await fetch("/api/history");
      const history = await res.json();
      history.forEach((entry, index) => {
        const div = document.createElement("div");
        div.className = "history-entry";
        const toggleId = `detail-${index}`;
        div.innerHTML = `<strong>${entry.time}</strong> - ${entry.pairs.length} anchor 
          <span class="toggle-details" onclick="toggleDetails('${toggleId}')">[Xem chi ti·∫øt]</span>
          <div id="${toggleId}" style="display:none; margin-top:5px;">
            <table class="w-full text-sm text-left table-auto mt-2 border-collapse">
              <thead>
                <tr class="border-b border-gray-200 bg-gray-50">
                  <th class="px-3 py-2 font-semibold text-gray-700">
                    <span class="flex items-center gap-2">
                      Anchor <button onclick="copyAnchorsFromEntry(${index})" class="text-xs bg-black text-[#fdfaf6] px-2 py-1 rounded hover:opacity-80">Copy</button>
                    </span>
                  </th>
                  <th class="px-3 py-2 font-semibold text-gray-700">
                    <span class="flex items-center gap-2">
                      URL <button onclick="copyUrlsFromEntry(${index})" class="text-xs bg-black text-[#fdfaf6] px-2 py-1 rounded hover:opacity-80">Copy</button>
                    </span>
                  </th>
                </tr>
              </thead>
              <tbody>
                ${entry.pairs.map(p => `
                  <tr class="border-b hover:bg-gray-50">
                    <td class="px-3 py-2">${p.anchor}</td>
                    <td class="px-3 py-2 text-blue-600">${p.url}</td>
                  </tr>
                `).join("")}
              </tbody>
            </table>
          </div>`;
        container.appendChild(div);
      });
    } catch (err) {
      container.innerHTML = "Kh√¥ng t·∫£i ƒë∆∞·ª£c l·ªãch s·ª≠.";
    }
  }

  function toggleDetails(id) {
    const el = document.getElementById(id);
    el.style.display = el.style.display === "none" ? "block" : "none";
  }

  function copyDivContent(id) {
    const range = document.createRange();
    range.selectNode(document.getElementById(id));
    window.getSelection().removeAllRanges();
    window.getSelection().addRange(range);
    document.execCommand("copy");
    window.getSelection().removeAllRanges();
    const copiedText = document.getElementById(id).innerText;
    const count = copiedText.split(/\| |\n/).filter(t => t.trim()).length;
    const popup = document.createElement("div");
    popup.innerText = `ƒê√£ copy ${count} anchor text!`;
    popup.className = "fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded shadow-lg animate-bounce";
    document.body.appendChild(popup);
    setTimeout(() => popup.remove(), 2000);
  }

  function copyRow(anchor, url) {
    const temp = document.createElement("textarea");
    temp.value = `${anchor} ‚Üí ${url}`;
    document.body.appendChild(temp);
    temp.select();
    document.execCommand("copy");
    document.body.removeChild(temp);

    const popup = document.createElement("div");
    popup.innerText = `ƒê√£ copy: ${anchor}`;
    popup.className = "fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded shadow-lg";
    document.body.appendChild(popup);
    setTimeout(() => popup.remove(), 2000);
  }

  function exportHtml() {
    const html = document.getElementById("anchorWithPipes").innerHTML + "<br><br>" +
                 document.getElementById("anchorWithSpaces").innerHTML;
    const blob = new Blob(["<html><body>" + html + "</body></html>"], { type: "text/html" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "anchor-links.html";
    link.click();
  }

  function copyAllAnchors() {
    fetch("/api/history")
      .then(res => res.json())
      .then(history => {
        const anchors = history.flatMap(entry => entry.pairs.map(p => p.anchor)).join("\n");
        copyTextAndNotify(anchors, "t·∫•t c·∫£ anchor");
      });
  }

  function copyAllUrls() {
    fetch("/api/history")
      .then(res => res.json())
      .then(history => {
        const urls = history.flatMap(entry => entry.pairs.map(p => p.url)).join("\n");
        copyTextAndNotify(urls, "t·∫•t c·∫£ URL");
      });
  }

  function copyTextAndNotify(text, label) {
    const temp = document.createElement("textarea");
    temp.value = text;
    document.body.appendChild(temp);
    temp.select();
    document.execCommand("copy");
    document.body.removeChild(temp);
    const popup = document.createElement("div");
    popup.innerText = `ƒê√£ copy ${label}!`;
    popup.className = "fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded shadow-lg";
    document.body.appendChild(popup);
    setTimeout(() => popup.remove(), 2000);
  }

  function copyAnchorsFromEntry(index) {
    fetch("/api/history")
      .then(res => res.json())
      .then(history => {
        const anchors = history[index].pairs.map(p => p.anchor).join("\n");
        copyTextAndNotify(anchors, `anchors (l·ªãch s·ª≠ #${index + 1})`);
      });
  }

  function copyUrlsFromEntry(index) {
    fetch("/api/history")
      .then(res => res.json())
      .then(history => {
        const urls = history[index].pairs.map(p => p.url).join("\n");
        copyTextAndNotify(urls, `URLs (l·ªãch s·ª≠ #${index + 1})`);
      });
  }

  document.addEventListener("DOMContentLoaded", renderHistory);
</script>

</body>
</html>
